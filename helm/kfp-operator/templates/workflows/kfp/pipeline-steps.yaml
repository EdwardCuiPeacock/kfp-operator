apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: {{ include "kfp-operator.fullname" . }}-pipeline-steps
spec:
  templates:
    - name: compile
      inputs:
        parameters:
        - name: compiler-config
        - name: pipeline-image
      outputs:
        artifacts:
        - name: pipeline
          path: /tmp/pipeline.yaml
      metadata:
        {{- .Values.manager.argo.metadataDefaults | toYaml | nindent 8 }}
      container:
        command:
          - python3
        image: "{{`{{inputs.parameters.pipeline-image}}`}}"
        name: pipeline
        volumeMounts:
        - mountPath: /shared
          name: shared
        args:
        - /shared/compile.py
        - --output_file
        - /tmp/pipeline.yaml
        - --pipeline_config
        - |
          {{`{{inputs.parameters.compiler-config}}`}}
        {{ .Values.manager.argo.containerDefaults | toYaml | nindent 8 }}
      volumes:
      - name: shared
      initContainers:
      - args:
        - /shared
        image: {{ include "kfp-operator.trimmedContainerRegistry" . }}kfp-operator-argo-kfp-compiler:{{ .Chart.AppVersion }}
        mirrorVolumeMounts: true
        name: compile
        {{ .Values.manager.argo.containerDefaults | toYaml | nindent 8 }}
    - name: upload
      inputs:
          artifacts:
          - name: pipeline
            path: /tmp/pipeline.yaml
          parameters:
          - name: pipeline-name
      metadata:
        {{- .Values.manager.argo.metadataDefaults | toYaml | nindent 8 }}
      script:
        command:
        - ash
        image: {{ .Values.containerRegistry }}kfp-operator-argo-kfp-sdk:{{ .Chart.AppVersion }}
        source: |-
          set -e -o pipefail
          kfp-ext --endpoint '{{ .Values.manager.argo.kfpEndpoint }}' --output json pipeline upload --pipeline-name '{{`{{inputs.parameters.pipeline-name}}`}}' '/tmp/pipeline.yaml' | jq -r '."Pipeline Details"."Pipeline ID"'
      {{ .Values.manager.argo.containerDefaults | toYaml | nindent 8 }}
    - name: update
      inputs:
        artifacts:
        - name: pipeline
          path: /tmp/pipeline.yaml
        parameters:
        - name: pipeline-id
        - name: pipeline-version
      metadata:
        {{ .Values.manager.argo.metadataDefaults | toYaml | nindent 8 }}
      script:
        command:
        - ash
        image: {{ .Values.containerRegistry }}kfp-operator-argo-kfp-sdk:{{ .Chart.AppVersion }}
        source: |-
          set -e -o pipefail
          kfp-ext --endpoint '{{ .Values.manager.argo.kfpEndpoint }}' --output json pipeline upload-version --pipeline-version '{{`{{inputs.parameters.pipeline-version}}`}}' --pipeline-id '{{`{{inputs.parameters.pipeline-id}}`}}' '/tmp/pipeline.yaml' | jq -r '."Version name"'
      {{ .Values.manager.argo.containerDefaults | toYaml | nindent 8 }}
    - name: delete
      inputs:
        parameters:
        - name: pipeline-id
      metadata:
        {{ .Values.manager.argo.metadataDefaults | toYaml | nindent 8 }}
      script:
        command:
        - ash
        image: {{ .Values.containerRegistry }}kfp-operator-argo-kfp-sdk:{{ .Chart.AppVersion }}
        source: |-
          set -e -o pipefail
          kfp-ext --endpoint '{{ .Values.manager.argo.kfpEndpoint }}' --output json pipeline delete '{{`{{inputs.parameters.pipeline-id}}`}}'
      {{ .Values.manager.argo.containerDefaults | toYaml | nindent 8 }}
---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: {{ include "kfp-operator.fullname" . }}-create-pipeline
spec:
  entrypoint: main
  {{ if .Values.manager.argo.serviceAccount -}}
  serviceAccountName: {{ .Values.manager.argo.serviceAccount }}
  {{- end }}
  arguments:
    parameters:
      - name: compiler-config
      - name: pipeline-image
      - name: pipeline-name
      - name: pipeline-version
  templates:
    - name: main
      outputs:
        parameters:
        - name: pipeline-id
          valueFrom:
            parameter: '{{`{{steps.upload.outputs.result}}`}}'
        - name: pipeline-version
          valueFrom:
            parameter: '{{`{{steps.update.outputs.result}}`}}'
      steps:
      - - name: compile
          arguments:
            parameters:
            - name: compiler-config
              value: '{{`{{workflow.parameters.compiler-config}}`}}'
            - name: pipeline-image
              value: '{{`{{workflow.parameters.pipeline-image}}`}}'
          templateRef:
            name: pipeline-steps
            template: compile
            clusterScope: true
      - - name: upload
          arguments:
            artifacts:
            - from: '{{`{{steps.compile.outputs.artifacts.pipeline}}`}}'
              name: pipeline
            parameters:
            - name: pipeline-name
              value: '{{`{{workflow.parameters.pipeline-name}}`}}'
          templateRef:
            name: pipeline-steps
            template: upload
            clusterScope: true
      - - name: update
          arguments:
            artifacts:
            - from: '{{`{{steps.compile.outputs.artifacts.pipeline}}`}}'
              name: pipeline
            parameters:
            - name: pipeline-id
              value: '{{`{{steps.upload.outputs.result}}`}}'
            - name: pipeline-version
              value: '{{`{{workflow.parameters.pipeline-version}}`}}'
          continueOn:
            failed: true
          templateRef:
            name: pipeline-steps
            template: update
            clusterScope: true
---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: {{ include "kfp-operator.fullname" . }}-update-pipeline
spec:
  entrypoint: main
  {{ if .Values.manager.argo.serviceAccount -}}
  serviceAccountName: {{ .Values.manager.argo.serviceAccount }}
  {{- end }}
  arguments:
    parameters:
      - name: compiler-config
      - name: pipeline-image
      - name: pipeline-id
      - name: pipeline-version
  templates:
    - name: main
      outputs:
        parameters:
        - name: pipeline-version
          valueFrom:
            parameter: '{{`{{steps.update.outputs.result}}`}}'
      steps:
      - - name: compile
          arguments:
            parameters:
            - name: compiler-config
              value: '{{`{{workflow.parameters.compiler-config}}`}}'
            - name: pipeline-image
              value: '{{`{{workflow.parameters.pipeline-image}}`}}'
          templateRef:
            name: pipeline-steps
            template: compile
            clusterScope: true
      - - name: update
          arguments:
            artifacts:
            - from: '{{`{{steps.compile.outputs.artifacts.pipeline}}`}}'
              name: pipeline
            parameters:
            - name: pipeline-id
              value: '{{`{{workflow.parameters.pipeline-id}}`}}'
            - name: pipeline-version
              value: '{{`{{workflow.parameters.pipeline-version}}`}}'
          templateRef:
            name: pipeline-steps
            template: update
            clusterScope: true
---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: kfp-operator-delete-pipeline
spec:
  entrypoint: main
  {{ if .Values.manager.argo.serviceAccount -}}
  serviceAccountName: {{ .Values.manager.argo.serviceAccount }}
  {{- end }}
  arguments:
    parameters:
    - name: pipeline-id
  templates:
  - name: main
    steps:
    - - name: delete
        templateRef:
          name: pipeline-steps
          template: delete
          clusterScope: true
        arguments:
          parameters:
          - name: pipeline-id
            value: '{{`{{workflow.parameters.pipeline-id}}`}}'
